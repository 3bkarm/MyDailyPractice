## [Find Sum of Array Product of Magical Sequences](https://leetcode.com/problems/find-sum-of-array-product-of-magical-sequences/description/?envType=daily-question&envId=2025-10-12)
```java
class Solution {
    public static final int mod = 1000_000_007, LIMIT = 50;
    private static int[] inv;

    static {
        inv = new int[LIMIT + 1];
        inv[1] = 1;
        for (int i = 2; i <= LIMIT; ++i) {
            inv[i] = mod - (int)( 1l * inv[mod % i] * (mod / i) % mod );
        }
    }

    private int n, m, k;
    private int[] nums;
    private int[][][][] dp;
    private boolean[][][][] vis;

    private int multiply(int a, int b) {
        return (int)(1l * a * b % mod);
    }

    private int solve(int ix, int done, int setBits, int carry) {
        if (done == m) {
            while (carry > 0) {
                setBits += carry % 2;
                carry /= 2;
            }
            if (setBits == k) {
                return 1;
            }
            return 0;
        }
        if (setBits >= k || ix == n) {
            return 0;
        }

        if (vis[ix][done][setBits][carry]) {
            return dp[ix][done][setBits][carry];
        }
        vis[ix][done][setBits][carry] = true;

        int ans = 0, c = 1, d = 1;
        for ( int take = 0; take + done <= m; ++take, c = multiply(c, nums[ix]), d = multiply(d, inv[take]) ) {
            int addBit = (take + carry) % 2;
            int newCarry = (take + carry) / 2;
            int add = multiply(c, d);
            add = multiply( add, solve(ix + 1, done + take, setBits + addBit, newCarry) );
            ans += add;
            if (ans >= mod) {
                ans -= mod;
            }
        }
        return dp[ix][done][setBits][carry] = ans;
    }

    public int magicalSum(int m, int k, int[] nums) {
        this.n = nums.length;
        this.m = m;
        this.k = k;
        this.nums = nums;
        dp = new int[n][m + 1][k + 1][m + 1];
        vis = new boolean[n][m + 1][k + 1][m + 1];
        int f = 1;
        for (int i = 2; i <= m; ++i) {
            f = multiply(f, i);
        }
        return multiply( f, solve(0, 0, 0, 0) );
    }
}
```
